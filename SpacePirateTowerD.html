<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Space Pirate Defense</title>
		<script ty pe="text/javascript" src="phaser.min.js"></script>
		<script type="text/javascript" src="tower.js"></script>
		<script type="text/javascript" src="brigBlaster.js"></script>
		<script type="text/javascript" src="clipCatast.js"></script>
		<script type="text/javascript" src="fleetSinker.js"></script>
		<!--Enemy Ships-->
		<script type="text/javascript" src="enemyClass.js"></script>
		<script type="text/javascript" src="enemyS-BrethrenOfTheCoast.js"></script>
		<script type="text/javascript" src="enemyS-ScourgeOfTheSevenSeas.js"></script>
		<script type="text/javascript" src="enemyS-TheSquirrel.js"></script>
		<script type="text/javascript" src="enemyS-RoyalFortune.js"></script>
		<script type="text/javascript" src="enemyS-FlyingDragon.js"></script>
		<script type="text/javascript" src="enemyS-AdmiralOfTheBlack.js"></script>
		
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>

<script type="text/javascript">

var game = new Phaser.Game(1920, 1920, Phaser.AUTO, '', { preload: preload, create: create, update: update, render: render});

//***************************
// Phaser Standard Functions
//***************************

//load necessary game assets
function preload() {
    //load map
    game.load.tilemap('pirateMapOcean', 'pirateMapProto4-2.json', null, Phaser.Tilemap.TILED_JSON);
    
    //Load Images
    game.load.image('tiles', 'tiles_sheet.png');
    game.load.image('sendNextWaveButtn', 'SendWaveRed.png');
    game.load.image('tree', 'Tree_1.png');
    game.load.image('shipsMisc3', '2nd_ship_new_3.png');
    game.load.atlasXML('shipsMisc1','shipsMiscellaneous_sheet.png','shipsMiscellaneous_sheet.xml');
    game.load.atlasXML('shipsMisc2','shipsMiscellaneous_sheet@2.png','shipsMiscellaneous_sheet@2.xml');
    game.load.image('villager', 'spr_m_unko.png'); 
    game.load.atlasXML('spaceItems', 'spaceItems.png', 'spaceItems.xml');
    game.load.image('star', 'star.png');
    
    
    game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
    //game.scale.setScreenSize(true);
    
}

//***************************
// Global Variables
//***************************
    
var map;
var layer;
var sendWaveButton;

//Sprites from spaceItems
var brigBlasterTower;
var clipCatastTower;
var fleetSinkerTower;

    
//Tower Groups
var berzerkers;

//Ranage Tower Group
var towerRange;

//Groups
var enemies;

//Tower weapons
var weaponBrigBlaster;
var weaponClipCatast;
var weaponFleetSinker;


var spTree;
var villager1;

//===Sprites====
var whiteShip = 'ship (1).png';
var blueShip = 'ship (17).png';
var blackShip = 'ship (24).png';
var redShip = 'ship (3).png';
var greenShip = 'ship (4).png';

//Self Made Path Variables
var level1Path = [];
var path1,path2,path3,path4,path5;
var timeoutIndex =0;


function create() {
    
    game.physics.startSystem(Phaser.Physics.ARCADE);
    
    //to load the map into the map
    map = game.add.tilemap('pirateMapOcean');
    //add the tileset from the json file
    map.addTilesetImage('tiles_sheet', 'tiles');
    
    
    layer = map.createLayer('Ground');
    layer = map.createLayer('Background');
    layer = map.createLayer('Foreground');
    layer = map.createLayer('TowerCollision');
    var style = { font: "bold 32px Arial", fill: "#fff", boundsAlignH: "center", boundsAlignV: "middle" };
    text = game.add.text(0, 0, "phaser 2.4 text bounds", style);
    //Send Wave Button
    sendWaveButton = game.add.sprite(1600,16,'sendNextWaveButtn');
    sendWaveButton.inputEnabled = true;
    sendWaveButton.scale.x = 1.5;
    sendWaveButton.scale.y = 1.5;
    
    
    //to create group for berzerker towers
    berzerkers = game.add.group();
    towerRange = game.add.group();
    
    //Init first tower objects
    brigBlasterTower = new BrigBlasterTower(game);
    clipCatastTower = new ClipCatastTower(game);
    fleetSinkerTower = new FleetSinkerTower(game);
    

    
    //Misc Sprites
    spTree = game.add.sprite(1250, 1000, 'tree');
    spTree.scale.x = .6;
    spTree.scale.y = .6;
    
    villager1 = game.add.sprite(1400, 600, 'villager');
    villager1.width = 100;
    villager1.height = 165;
    
    
    //Game Board Alignment
    layer.resizeWorld();
    game.scale.pageAlignVertically = true;
    game.scale.pageAlignHorizontally = true; 
    game.scale.refresh();


    //Enemies
    enemies = game.add.group();
    game.physics.arcade.enable(enemies);
   
    weaponBrigBlaster = game.add.weapon(30, 'spaceItems', 'beam6.png');
    weaponClipCatast = game.add.weapon(30, 'spaceItems', 'beam1.png');
    weaponFleetSinker = game.add.weapon(30,'spaceItems', 'laserGreen13.png');
   
    weaponBrigBlaster.bulletKillType = Phaser.Weapon.KILL_DISTANCE;
    weaponBrigBlaster.bulletKillDistance = 300;
    weaponBrigBlaster.bulletSpeed = 2000;
    weaponBrigBlaster.fireRate = 150;
    weaponBrigBlaster.trackRotation = true;
    weaponBrigBlaster.autoFire = true;    
    weaponBrigBlaster.multiFire = true;
    
    weaponClipCatast.bulletKillType = Phaser.Weapon.KILL_DISTANCE;
    weaponClipCatast.bulletKillDistance = 75;
    weaponClipCatast.bulletSpeed = 3000;
    weaponClipCatast.fireRate = 150;
    weaponClipCatast.trackRotation = true;
    weaponClipCatast.autoFire = true;    
    weaponClipCatast.multiFire = true;
    
    weaponFleetSinker.bulletKillType = Phaser.Weapon.KILL_DISTANCE;
    weaponFleetSinker.bulletKillDistance = 50;
    weaponFleetSinker.bulletSpeed = 4000;
    weaponFleetSinker.fireRate = 75;
    weaponFleetSinker.trackRotation = true;
    weaponFleetSinker.autoFire = true;    
    weaponFleetSinker.multiFire = true;


     //Self Made Path Variables
    path1 = [{x:200,y:535},{x:1695,y:520},{x:1695,y:860},{x:70,y:860},{x:70,y:1820},{x:2500,y:1820}];
    path2 = [{x:200,y:535},{x:1150,y:520},{x:1150,y:190},{x:1695,y:190},{x:1695,y:860},{x:70,y:860},{x:70,y:1820},{x:2500,y:1820}];
    //Path 3 goes around the first island
    path3 = [{x:200,y:535},{x:510,y:520},{x:510,y:860},{x:1040,y:860},{x:1040,y:1420},{x:70,y:1420},{x:70,y:1820},{x:2500,y:1820}];
    path4 = [{x:200,y:535},{x:1695,y:520},{x:1695,y:860},{x:1000,y:860},{x:1000,y:1420},{x:70,y:1420},{x:70,y:1820},{x:2500,y:1820}];
    level1Path = [path1,path2,path3,path4];
  
    //Initiate Tween
    sendWaveButton.events.onInputDown.add(wave1, this);
    
}



function update() {
    
    //to have the towers follow the ships need to ensure there are items in the group
    if(enemies.length != 0){    
        berzerkers.forEach(function(item){
            //item.rotation = game.physics.arcade.angleBetween(item, enemies.children[0]) - 80;
        }, this);  
    }
    
    
    //Check for collision between bullets and enemies
    game.physics.arcade.overlap(weaponBrigBlaster.bullets, enemies, collisionCheck, null, this);
    game.physics.arcade.overlap(weaponClipCatast.bullets, enemies, collisionCheck, null, this);
    game.physics.arcade.overlap(weaponFleetSinker.bullets, enemies, collisionCheck, null, this);
   
}

//Removes enemies killed
function collisionCheck(star, enemy){
    console.log(enemy.damage);
    star.kill();
    enemy.destroy();
}
 
    
function render(){
    
    game.debug.body(berzerkers);
}


//================================
//ENEMY LEVEL 1 WAVES

function wave1() {
    sendWave(brethren,10,level1Path,null,
    wrapSendWave(scourge,1,level1Path,null,
    wrapSendWave(brethren,2,level1Path,null,wave2)));
    sendWaveButton.visible = false;
}

function wave2(){
    sendWaveButton.visible = true;
    sendWaveButton.events.onInputDown.removeAll();
    // sendWaveButton.events.onInputDown.add(wrapSendWave(admiral,1,level1Path,sendWaveButton), this);

    sendWaveButton.events.onInputDown.add(
        wrapSendWave(brethren,4,level1Path,sendWaveButton,
        wrapSendWave(scourge,5,level1Path,null,
        wrapSendWave(brethren,1,level1Path,null,
        wrapSendWave(scourge,5,level1Path,null,wave3)))), this);
}

function wave3(){
    sendWaveButton.visible = true;
    sendWaveButton.events.onInputDown.removeAll();
        sendWaveButton.events.onInputDown.add(
        wrapSendWave(squirrel,2,level1Path,sendWaveButton,
        wrapSendWave(scourge,5,level1Path,null,
        wrapSendWave(brethren,2,level1Path,null,
        wrapSendWave(squirrel,6,level1Path,null,wave4)))), this);
}

function wave4(){
    sendWaveButton.visible = true;
    sendWaveButton.events.onInputDown.removeAll();
        sendWaveButton.events.onInputDown.add(
        wrapSendWave(squirrel,5,level1Path,sendWaveButton,
        wrapSendWave(royal,4,level1Path,null,
        wrapSendWave(brethren,2,level1Path,null,
        wrapSendWave(scourge,9,level1Path,null,wave5)))), this);
}

function wave5(){
    sendWaveButton.visible = true;
    sendWaveButton.events.onInputDown.removeAll();
        sendWaveButton.events.onInputDown.add(
        wrapSendWave(royal,5,level1Path,sendWaveButton,
        wrapSendWave(squirrel,2,level1Path,null,
        wrapSendWave(royal,8,level1Path,null,
        wrapSendWave(dragon,1,level1Path,null,wave6)))), this);
}

function wave6(){
    sendWaveButton.visible = true;
    sendWaveButton.events.onInputDown.removeAll();
        sendWaveButton.events.onInputDown.add(
        wrapSendWave(squirrel,2,level1Path,sendWaveButton,
        wrapSendWave(dragon,5,level1Path,null,
        wrapSendWave(brethren,1,level1Path,null,
        wrapSendWave(royal,6,level1Path,null,wave7)))), this);
}

function wave7(){
    sendWaveButton.visible = true;
    sendWaveButton.events.onInputDown.removeAll();
        sendWaveButton.events.onInputDown.add(
        wrapSendWave(dragon,5,level1Path,sendWaveButton,
        wrapSendWave(royal,15,level1Path,null,wave8)), this);
}

function wave8(){
    sendWaveButton.visible = true;
    sendWaveButton.events.onInputDown.removeAll();
        sendWaveButton.events.onInputDown.add(
        wrapSendWave(squirrel,3,level1Path,sendWaveButton,
        wrapSendWave(admiral,2,level1Path,null,
        wrapSendWave(royal,10,level1Path,null,wave9))), this);
}

function wave9(){
    sendWaveButton.visible = true;
    sendWaveButton.events.onInputDown.removeAll();
        sendWaveButton.events.onInputDown.add(
        wrapSendWave(brethren,3,level1Path,sendWaveButton,
        wrapSendWave(scourge,1,level1Path,null,
        wrapSendWave(squirrel,2,level1Path,null,
        wrapSendWave(royal,2,level1Path,null,
        wrapSendWave(dragon,5,level1Path,null,
        wrapSendWave(admiral,8,level1Path,null,wave10)))))), this);
}

function wave10(){
    sendWaveButton.visible = true;
    sendWaveButton.events.onInputDown.removeAll();
        sendWaveButton.events.onInputDown.add(
        wrapSendWave(dragon,10,level1Path,sendWaveButton,
        wrapSendWave(admiral,15,level1Path,null)), this);
}

//ENEMY LEVEL 1 WAVES
//============================


</script>

</body>
</html>